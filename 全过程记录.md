# CFPS 数据处理与实证分析流程记录

## 1. 研究目的、数据合规与可复现性原则

本项目以中国家庭追踪调查（CFPS）2010–2020 年多轮追踪数据为基础，构建农业经营主体微观样本，完成如下实证工作：

- 样本构建：从家庭经济与农业收支模块中识别农业经营样本，并形成家庭—年份面板数据。
- 变量测度：测算农业全要素生产率（TFP；以 `lnTFP` 表示），并构建数字化/人工智能相关综合指标（`AI_Index`）。
- 计量识别：输出 OLS、PSM 及因果森林替代（见第 7 节）等结果与可用于论文替换的表格/图形。

数据合规原则：CFPS 数据受使用协议约束，**不得公开传播原始数据文件（.dta）或记录级数据**。如采用 GitHub 管理版本，仅上传代码、流程文档与汇总级输出（不包含记录级原始观测）。

## 2. 工作区结构与文件组织

- `原始数据/`：CFPS 原始数据（按年份与模块存放）。
- `data/`：从 `原始数据/` 中筛选得到的最小必要 `.dta` 文件集合（用于复现实证，便于降低 I/O 负担）。
- `output/`：脚本运行输出（CSV/PNG 等）。
- `causal_analysis.py`：主脚本（生成论文“完整口径”样本与估计结果）。
- `lunwen.txt`：论文正文（用于将示例数值替换为真实结果）。

## 3. 数据来源与模块说明

CFPS 数据按年度提供多个模块，本项目主要使用：
- `famecon`：家庭经济与农业收支（农业产出、投入、固定资产、土地等），用于构建 TFP 核心变量。
- `adult/person`：个人/成人问卷（年龄、受教育、健康、培训、互联网/手机使用等），用于构建控制变量与 `AI_Index`。
- `famconf`：家庭成员与结构信息（用于跨年追踪与成员编码的辅助）。
- `comm`：社区层面信息（本项目未作为必要变量，仅作为可扩展数据源）。

## 4. 数据抽取与样本构建（原始数据 → data/）

为降低全量数据（约 3–5GB）反复读取成本，并提升可复现性，本项目将必要数据文件复制至 `data/`。已纳入的核心文件包括：

- 2010：`cfps2010famecon_202008.dta`, `cfps2010famconf_202008.dta`, `cfps2010adult_202008.dta`, `cfps2010comm_201906.dta`
- 2012：`cfps2012famecon_201906.dta`, `cfps2012famconf_092015.dta`, `cfps2012adult_201906.dta`
- 2014：`cfps2014famecon_201906.dta`, `cfps2014famconf_170630.dta`, `cfps2014adult_201906.dta`, `cfps2014comm_201906.dta`
- 2016：`cfps2016famecon_201807.dta`, `cfps2016famconf_201804.dta`, `cfps2016adult_201906.dta`
- 2018：`cfps2018famecon_202101.dta`, `cfps2018famconf_202008.dta`, `cfps2018person_202012.dta`, `cfps2018crossyearid_202104.dta`
- 2020：`cfps2020famecon_202306.dta`, `cfps2020famconf_202301.dta`, `cfps2020person_202112.dta`

## 5. 计算环境与依赖

- 操作系统：Windows
- Python：3.14（x64）

依赖包（用于读取 `.dta`、PCA、回归、匹配与绘图）：

- `pandas numpy pyreadstat`
- `scikit-learn statsmodels matplotlib seaborn`

说明：在 Windows + Python 3.14 环境下，部分因果推断库（例如 `econml`）可能触发编译依赖（C++ 编译器），导致安装失败。本项目采用可运行的替代策略，并在第 7 节阐明。

## 6. 变量测度：产出/投入与 TFP（lnTFP）

核心脚本：`causal_analysis.py`

### 6.1 农业产出（Y）

根据各年份问卷结构差异，程序采用“优先级匹配”规则自动抽取农业产出：

- 2010：优先 `inc_agri`，否则使用 `fk3`（农林牧副渔毛收入）。
- 2012+：采用 `fl3/fl9/...` 等“农林/农副产品总值”结构进行合成。

### 6.2 投入要素（K、M、L）

- 资本投入 `K`：`fixed_asset`（生产性固定资产）。
- 中间品投入 `M`：种子化肥农药、灌溉、机器租赁、饲料等费用按年份可用字段合成。
- 劳动投入 `L`：以雇工费 `L_cost` 作为劳动投入代理变量（跨年可比性较好）。

### 6.3 TFP（lnTFP）计算

采用生产函数 OLS 残差法构造 `lnTFP`：

- `lnY = β0 + βK lnK + βM lnM + βL lnL + ε`
- 以残差 `ε` 表示 `lnTFP`

## 7. 论文完整口径：户主控制变量 + AI_Index（PCA）+ 识别方法

### 7.1 户主/主事人 PID 映射（用于个人层合并）

由于不同年份“户主”字段命名不一致，脚本以如下优先级构造 `head_pid`：

- `headpid`（家庭主事人；2020 明确存在）
- `resp1pid`/`fresp1pid`（财务回答人）
- `fl2pid`/`resp2pid`/`fresp2pid`（农业活动管账人/农业收支回答人）
- `fz1pid`（问卷主要受访者）

### 7.2 控制变量（个人层→家庭层）

通过 `head_pid + year` 从 `adult/person` 抽取并合并至家庭面板：

- `age`：年龄
- `edu`：受教育年限（例如 `cfps2018eduy_im`, `cfps2020eduy_im`）
- `health`：自评健康
- `train`：培训经历（统一转换为 0/1）

### 7.3 AI_Index（PCA）构建

以个人问卷中可跨年匹配的“手机/上网/互联网用途与频率”等题项构造数字化综合指标，并按年度分别实施 PCA：

- 每一年单独提取第一主成分作为 `AI_Index`
- 在年内标准化为均值 0、标准差 1
- `pca_loadings.csv` 输出载荷与解释方差，便于在论文中报告构建过程

### 7.4 计量与因果识别

- **OLS 基准回归**：输出 `ols_results.csv`
- **PSM**：Logit 倾向得分 + 最近邻匹配，输出 `psm_results.csv`
- **因果森林/GRF 替代**：
  - 由于 Windows + Python 3.14 下 `econml` 可能受编译依赖限制，本项目采用可运行替代：**T-learner 随机森林（两模型差分）**。
  - 输出 `causal_forest_proxy_summary.csv`，并提供教育/资产分组异质性表。

同时，由于变量缺失的交集会降低可用样本量，脚本生成 `model_sample_report.csv`，记录在给定 `lnTFP` 与 `AI_Index` 的基础上，控制变量的可用交集与最终进入模型的协变量组合。

## 8. 输出文件（可用于论文替换）

位于 `output/`：

- `processed_data_full.csv`：完整口径样本（含 `lnTFP`, `AI_Index`, 控制变量等）
- `descriptive_stats_full.csv`：完整口径描述性统计（用于论文表4-1等）
- `pca_loadings.csv`：PCA 载荷
- `ols_results.csv`：OLS 回归结果
- `psm_results.csv`：PSM 结果
- `causal_forest_proxy_summary.csv`：因果森林替代汇总
- `heterogeneity_by_edu.csv`：按教育分组异质性
- `heterogeneity_by_asset.csv`：按资产分组异质性
- `method_comparison.png`：方法比较图
- `model_sample_report.csv`：样本口径与协变量选择报告

## 9. 可复现运行指令

在项目根目录执行：

- `python causal_analysis.py`

运行成功后，所有结果输出至 `output/`。

## 10. GitHub 版本管理建议（合规）

- 本项目可通过 GitHub 进行代码与流程文档的版本管理，以提升可复现性与过程可审计性。
- **严禁上传**：`原始数据/`、`data/`、任何 `.dta` 文件及记录级输出（例如 `processed_data*.csv`）。
- 可上传内容包括：脚本源码、`全过程记录.md`、以及汇总级输出（如描述性统计、回归表、PCA 载荷、图）。

## 11. 局限性与未来研究方向（SCI/SSCI期刊标准）

1. **方法与识别策略局限**
   - 本文因操作系统与依赖环境限制，采用 T-learner 随机森林作为因果森林（GRF）的近似实现，未能完全复现官方 GRF（R 包 `grf` 或 Python `econml`）。未来可在支持 C++ 编译环境的 Python 3.10/3.11 或 R 生态下，严格实现因果森林与异质性处理效应估计。
   - 目前的 OLS/PSM/因果森林替代均基于观测性数据，无法完全排除所有内生性与未观测混杂，结果应理解为“条件异质性”下的准因果推断。

2. **变量测度与机制分析局限**
   - 由于 CFPS 问卷结构与变量命名跨年存在差异，部分机制变量（如合作社参与、土地流转、信贷约束、地区异质性等）未能在所有年份实现一致测度，机制分析的广度与深度受限。
   - 数字化/AI 指数（AI_Index）基于可用的互联网/手机相关题项，未能覆盖所有智能化、自动化、信息获取等维度，PCA 结果的解释力有限。

3. **数据结构与外推性**
   - 样本仅覆盖参与 CFPS 调查的中国农村家庭，部分年份因变量缺失导致样本量下降，影响结果的代表性与稳健性。
   - 农业经营主体的定义基于问卷自报与模块合成，可能存在身份错配或测度误差。

4. **未来研究方向**
   - 建议未来结合多源数据（如遥感、市场交易、政策试点等）提升变量测度的准确性与机制识别的多维度。
   - 可进一步采用工具变量法、双重差分等准实验设计，增强因果推断的识别强度。
   - 鼓励在 R/官方 Python `grf` 环境下复现异质性处理效应，并细化教育、资产、地区、机制等分组的异质性分析。
   - 深化对合作社、土地流转、信贷约束、市场接入等机制变量的系统性测度与作用机制识别。

